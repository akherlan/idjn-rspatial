---
title: "Analisis Data Spasial dengan R"
author: "Andi K. Herlan"
output:
  html_document:
    toc: yes
    toc_collapsed: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

```{r, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE, 
  warning = FALSE,
  message = FALSE
)
```

## Pengenalan #rspatial

### Representasi Objek Nyata dalam Komputer

#### 1. Simple features

Menjelaskan bagaimana objek-objek dalam dunia nyata bisa diwakilkan ke dalam komputer, dengan penekanan pada bentuk (geometri) spasial objek tersebut.

- *geometry* berhubungan dengan bentuk benda/objek dan posisinya di permukaan Bumi.
- *attributes* menjelaskan sifat-sifatnya (properties) atau keterangan tambahan, biasanya dalam bentuk tabular.

Geometri yang sering digunakan adalah dalam dimensi 2, seperti:

- titik (point), misal: lokasi
- garis (line), misal: jalan, batas wilayah
- poligon (polygon), misal: luas area, kawasan hutan

![Perbedaan berbagai fitur](assets/features_diff.png "Feature geometry oleh Levinson")

Credit image to [Levinson](https://transportist.org/2019/11/06/catchment-if-you-can-the-effect-of-station-entrance-and-exit-locations-on-accessibility/)

#### 2. Coordinate Reference System (CRS)

Menjelaskan kedudukan benda/objek di muka Bumi.

- Proyeksi, misal: longlat, zona UTM
- Datum, misal: WGS 84, NAD27, etc.

### Library `sf`

`sf`: Simple Features for R

- menggunakan format tabel (data.frames atau tibbles) dengan lengkap dengan geometry dan CRS-nya
- Semua fungsi dimuali dengan `st_` sehingga mudah menggunakan tab completion di RStudio
- merepresentasikan 17 bentuk/tipe simple feature secara langsung di R untuk semua dimensi (XY, XYZ, XYM, XYZM)
- fungsi-fungsi dari `sp`, `rgeos`, `rgdal` bisa dilakukan di `sf`

## Requirements (Tools)

**Windows:**

- R | [unduh](https://cran.r-project.org/)
- RStudio | [unduh](https://rstudio.com/products/rstudio/download/)
- Rtools | [unduh](https://cran.r-project.org/bin/windows/Rtools/)

**Linux & MacOS:**

- R
- RStudio | [unduh](https://rstudio.com/products/rstudio/download/)
- GDAL, GEOS, PROJ | [konfigurasi](https://r-spatial.github.io/sf/#installing)

*Install R di Ubuntu*

```{}
sudo apt-get install r-base
```

**Library (Windows, MacOS, Linux):**

```{R muat package diperlukan, message=FALSE, warning=FALSE}
if(!require("sf")) install.packages("sf")
if(!require("dplyr")) install.packages("dplyr")
if(!require("rnaturalearth")) install.packages("rnaturalearth")
```

## Data Preparation

Pada meet up lalu, kita telah belajar tentang cara mendapatkan data titik sebaran lokasi rumah sakit dari webgis menggunakan R library `esri2sf`.

Muat data tersebut dari file .rds yang ada di dalam folder data:

```{R}
rs <- readRDS("data/data.rds")
```

Mengetahui kelas data/objek dan strukturnya:

```{R struktur data}
class(rs)
# print(rs, n = 5)
```

## Plot Data Spasial Menggunakan `sf`

Secara default kita bisa menampilkan data spasial menggunakan library `sf`.

**1. Cara plot objek kelas `sf`**

```{R plot sf}
plot(st_geometry(rs))
```


```{R impor csv}

# Bagaimana jika datanya berbentuk tabular dalam berkas atau .csv?

# puskes.tbl <- read.csv("data/puskes.csv")
# print(puskes.tbl, n = 5) # melihat struktur data/objek

# *PR : ubah format tabular ke format sf*
```

**2. Plot data lokasi RS ke peta Indonesia**

```{R plot data ke peta indonesia}
id <- rnaturalearth::ne_countries(country = "indonesia", returnclass = "sf")
plot(st_geometry(id))
plot(st_geometry(rs), add = TRUE)
```

**3. Menampilkan lokasi RS di wilayah Pontianak**

```{R plot data ke peta pontianak}
# Memuat peta Kota Pontianak
pontianak <- read_sf("data/peta/pontianak_kota.shp")
plot(st_geometry(pontianak))

# plot titik dari area of interest, masih ada warning
bb_pontianak <- st_bbox(pontianak)

library(dplyr)
rs %>% 
  st_crop(bb_pontianak) %>% 
  st_geometry() %>% 
  plot(add = TRUE)
```

**4. Transformasi referensi koordinat (CRS)**

Memperoleh informasi CRS dari data sebaran RS dan peta:

```{R}
st_crs(rs)
st_crs(pontianak)
```

Untuk mengubah CRS ke nilai tertentu, lakukan:

```{R definisikan crs}
crs.id <- 23838 # ambil dari web epsg.io

rs.id <- st_transform(rs, crs.id)
pontianak.id <- st_transform(pontianak, crs.id)

st_crs(rs.id)
st_crs(pontianak.id)

pontianak %>% 
  st_geometry() %>% 
  plot()

pontianak.id %>% 
  st_geometry() %>% 
  plot(add = TRUE) # PR: harus diberi warna
```

Lalu di mana letak perbedaannya? Mari kita telaah:

```{R perbedaan units pada bbox}
st_bbox(rs)
st_bbox(rs.id)
```

Apa yang berbeda?

**5. Membuat buffer area**

Membuat batas area:

```{R membuat buffer area}
buff <- st_buffer(st_geometry(rs.id), dist = 1000)

aoi <- st_bbox(pontianak.id)

pontianak.id %>% 
  st_geometry() %>% 
  plot(border = "blue")

rs.id %>%
  st_crop(aoi) %>% 
  st_geometry() %>% 
  plot(add = TRUE)

buff %>%
  st_crop(aoi) %>% 
  st_geometry() %>% 
  plot(add = TRUE, border = "red")
```

**5. Plot dengan `ggplot2`**

```{R plot ggplot2}
library(ggplot2)
ggplot() +
  geom_sf(data = pontianak) +
  theme_bw() +
  geom_sf(data = st_crop(rs, bb_pontianak), pch = 0.3)
```

Sekian. Terima kasih. Nanti kita modifikasi lagi.

```{r ggmap, eval=FALSE, include=FALSE}
library(ggplot2)
library(ggmap)
library(sf)

#our background map
lon = 106.3
lat = 0
pontianak_map <- get_map(center = c(lon,lat))

#final map
ggmap(mad_map)+
  geom_sf(data=st_geometry(rs),
          inherit.aes =FALSE,
          colour="#238443",
          fill="#004529",
          alpha=.5,
          size=4,
          shape=21)+
  labs(x="",y="")
```


## Referensi dan Bahan Bacaan

- Penjelasan tentang olah data spasial | [intro gis with R](https://www.jessesadler.com/post/gis-with-r-intro/)
- Kata Wikipedia tentang [simple features](https://en.wikipedia.org/wiki/Simple_Features)
- Penjelasan tentang `sf` | [dokumentasi](https://cran.r-project.org/web/packages/sf/vignettes/sf1.html)
- Modifikasi data spasial kelas `sf` | [tidy sf](http://strimas.com/r/tidy-sf/)
- Cara menggunakan `esri2sf` | [Materi meet up lalu oleh @wanulfa](https://github.com/wanulfa/argis-server)
- Plotting peta dengan `sf` dan `ggplot2` | [artikel](https://www.r-bloggers.com/zooming-in-on-maps-with-sf-and-ggplot2/)
- Buku [Geocomputational in R](https://geocompr.robinlovelace.net/spatial-class.html) oleh Robin Lovelace & Jakub Nowosad